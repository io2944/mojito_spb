stages:
  - build
  - test
  - quality
  - sonarcloud
  - package

# Cache Maven local pour acc√©l√©rer les builds
cache:
  key: "${CI_JOB_NAME}"
  paths:
    - .m2/repository

# -----------------------------
# üîß BUILD STAGE
# -----------------------------
build-job:
  stage: build
  image: maven:3.9-eclipse-temurin-25
  script:
    - echo "üèóÔ∏è Compilation du projet..."
    - mvn -B clean compile
  artifacts:
    paths:
      - target/
    expire_in: 1 week

# -----------------------------
# ‚úÖ TEST STAGE
# -----------------------------
test-job:
  stage: test
  image: maven:3.9-eclipse-temurin-25
  services:
    - name: postgres:17
      alias: mojitodb
  variables:
    POSTGRES_DB: mojitodb
    POSTGRES_USER: user
    POSTGRES_PASSWORD: mdp
    SPRING_DATASOURCE_URL: jdbc:postgresql://mojitodb:5432/mojitodb
    SPRING_DATASOURCE_USERNAME: user
    SPRING_DATASOURCE_PASSWORD: mdp
  before_script:
    - apt-get update -qq && apt-get install -y -qq postgresql-client
    - echo "Waiting for PostgreSQL to be ready..."
    - until pg_isready -h mojitodb -p 5432; do sleep 2; done
    - echo "‚úÖ PostgreSQL is ready!"
  script:
    - echo "üö¶ Lancement des tests Maven..."
    - mvn -B test
  artifacts:
    when: always
    reports:
      junit: target/surefire-reports/TEST-*.xml

# -----------------------------
# üìä CODE QUALITY STAGE
# -----------------------------
code_quality_job:
  stage: quality
  image: docker:27
  services:
    - docker:27-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
  allow_failure: true
  script:
    - mkdir -p codequality-results
    - docker run --rm \
        --env CODECLIMATE_CODE="$PWD" \
        --volume "$PWD":/code \
        --volume /var/run/docker.sock:/var/run/docker.sock \
        --volume /tmp/cc:/tmp/cc \
        codeclimate/codeclimate analyze -f html > ./codequality-results/index.html
  artifacts:
    paths:
      - codequality-results/
    expire_in: 1 week

# -----------------------------
# üîé SONARCLOUD STAGE
# -----------------------------
.sonarcloud-check:
  stage: sonarcloud
  image: maven:3.9-eclipse-temurin-25
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
    GIT_DEPTH: "0"
  script:
    - echo "üîç Analyse SonarCloud..."
    - mvn verify sonar:sonar -Dsonar.projectKey=glft-szoEksYBzRTp3V9B7xVZ
  cache:
    key: "${CI_JOB_NAME}"

# -----------------------------
# üì¶ PACKAGE & DOCKER STAGE
# -----------------------------
package_job:
  stage: package
  image: maven:3.9-eclipse-temurin-25
  services:
    - docker:27-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
  script:
    - echo "üèóÔ∏è Construction de l'image Docker Spring Boot..."
    - mvn -B spring-boot:build-image \
        -Dspring-boot.build-image.imageName=registry.gitlab.com/helenerv/mojito/mojito-app:${CI_COMMIT_SHORT_SHA} \
        -DskipTests
    - echo "üîê Connexion au registre GitLab..."
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" "$CI_REGISTRY" --password-stdin
    - docker push registry.gitlab.com/helenerv/mojito/mojito-app:${CI_COMMIT_SHORT_SHA}
  only:
    - main
